rule Advanced_Malware_Detection_Lab6_Task3
{
    meta:
        description = "Advanced malware detection based on string analysis from Lab 6-1"
        author = "Security Analyst"
        date = "2024-01-20"
        version = "1.0"
        sample_hash = "unknown"
        
    strings:
        // Suspicious API calls commonly used by malware
        $api1 = "VirtualAlloc" ascii
        $api2 = "VirtualAllocEx" ascii  
        $api3 = "GetProcAddress" ascii
        $api4 = "LoadLibraryA" ascii
        $api5 = "LoadLibraryW" ascii
        $api6 = "WriteFile" ascii
        $api7 = "CreateFileA" ascii
        
        // Network-related indicators
        $url1 = "http://s.symcd.com" ascii
        $url2 = "https://d.symcb.com" ascii
        $url3 = "http://ts-crl.ws.symantec.com" ascii
        $url4 = "http://ts-ocsp.ws.symantec.com" ascii
        
        // Obfuscated or suspicious text patterns
        $obfus1 = "Madelimi ticataw cisa veque hopes wipap bepacet fajij fonenin pef" ascii
        $obfus2 = "Kaquajip" ascii
        $obfus3 = "Hoqui jatipo" ascii
        $obfus4 = "Codase samo jad welo bixipox" ascii
        
        // Runtime error patterns (potential packing indicators)
        $runtime1 = "Microsoft Visual C++ Runtime Library" ascii
        $runtime2 = "bad allocation" ascii
        $runtime3 = "HEAP CORRUPTION DETECTED" ascii
        $runtime4 = "This program cannot be run in DOS mode" ascii
        
        // File header
        $mz_header = { 4D 5A }  // MZ header
        
        // Certificate and trust network strings (potential cert manipulation)
        $cert1 = "Symantec Trust Network" ascii
        $cert2 = "VeriSign Trust Network" ascii
        $cert3 = "www.entrust.net/legal-terms" ascii
        
    condition:
        // Must be a Windows PE file
        $mz_header at 0 and
        
        // At least 3 suspicious API calls
        3 of ($api*) and
        
        // Either network indicators OR obfuscated strings OR certificate manipulation
        (
            any of ($url*) or
            2 of ($obfus*) or
            any of ($cert*)
        ) and
        
        // Runtime indicators suggesting potential packing/obfuscation
        any of ($runtime*) and
        
        // File size constraints (typical malware size range)
        filesize > 100KB and filesize < 10MB
}

rule Specific_Malware_Patterns_Lab6
{
    meta:
        description = "Specific patterns found in the analyzed malware sample"
        author = "Security Analyst"
        reference = "Lab 6-1 Analysis"
        
    strings:
        // Specific suspicious string combinations found
        $pattern1 = "Vec rom sam wed fota vejag mejarido naqu niwefo" ascii
        $pattern2 = "Vacagil xeb saweha bema bavi watataj nejeq caf vimoxi wik" ascii
        $pattern3 = "Quec!" ascii
        $pattern4 = "l1p1t1" ascii
        
        // Memory allocation and manipulation
        $mem1 = "VirtualAllocEx" ascii
        $mem2 = "GetProcAddress" ascii
        
        // File operations
        $file1 = "CreateFileA" ascii
        $file2 = "WriteFile" ascii
        
    condition:
        2 of ($pattern*) and
        all of ($mem*) and
        any of ($file*)
}

rule Certificate_Manipulation_Indicator
{
    meta:
        description = "Detects potential certificate manipulation based on observed URLs"
        author = "Security Analyst"
        
    strings:
        $symantec1 = "https://d.symcb.com/cps" ascii
        $symantec2 = "http://ts-crl.ws.symantec.com" ascii
        $symantec3 = "http://ts-ocsp.ws.symantec.com" ascii
        $trust = "Symantec Trust Network" ascii
        
    condition:
        2 of them
}