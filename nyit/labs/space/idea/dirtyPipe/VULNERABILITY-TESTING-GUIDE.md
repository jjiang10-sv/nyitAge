# CVE-2022-0847 (Dirty Pipe) Vulnerability Testing Guide

## üö® **CRITICAL: Vulnerable Kernel Versions**

CVE-2022-0847 affects Linux kernel versions:
- **Vulnerable**: 5.8.0 to 5.10.101, 5.11.0 to 5.15.24, 5.16.0 to 5.16.10
- **Patched**: 5.10.102+, 5.15.25+, 5.16.11+

## üìã **Methods to Reproduce in Vulnerable Kernels**

### Method 1: Virtual Machine with Older Ubuntu Versions

#### Option A: Ubuntu 20.04 LTS with Kernel 5.11
```bash
# Download Ubuntu 20.04.3 (ships with kernel 5.11.x)
wget https://old-releases.ubuntu.com/releases/20.04.3/ubuntu-20.04.3-desktop-amd64.iso

# Create VM with at least 2GB RAM, disable kernel updates:
sudo apt-mark hold linux-*
sudo systemctl disable unattended-upgrades
```

#### Option B: Ubuntu 21.04 (Hirsute) - HIGHLY VULNERABLE
```bash
# Ubuntu 21.04 shipped with kernel 5.11.x (vulnerable)
wget https://old-releases.ubuntu.com/releases/21.04/ubuntu-21.04-desktop-amd64.iso

# After installation, prevent kernel updates:
sudo apt-mark hold linux-*
sudo apt-mark hold linux-image-*
sudo apt-mark hold linux-headers-*
```

### Method 2: Manual Kernel Compilation (Advanced)

#### Compile Vulnerable Kernel 5.15.20
```bash
# Install build dependencies
sudo apt update
sudo apt install -y build-essential libncurses-dev bison flex libssl-dev libelf-dev

# Download vulnerable kernel source
wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.15.20.tar.xz
tar -xf linux-5.15.20.tar.xz
cd linux-5.15.20

# Configure and compile
make menuconfig  # Use default config
make -j$(nproc)
sudo make modules_install install

# Update GRUB and reboot
sudo update-grub
sudo reboot
```

### Method 3: Container with Vulnerable Kernel (Docker)

‚ö†Ô∏è **Note**: Containers share the host kernel, so you need a host with vulnerable kernel.

#### Using Vagrant with Vulnerable Kernel
```bash
# Create Vagrantfile for Ubuntu 20.04 with kernel 5.11
cat > Vagrantfile << 'EOF'
Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"
  config.vm.box_version = "20210415.0.0"  # Ships with 5.11.x
  
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
  end
  
  config.vm.provision "shell", inline: <<-SHELL
    # Prevent kernel updates
    apt-mark hold linux-*
    apt update
    apt install -y gcc build-essential
    echo "Kernel version: $(uname -r)"
  SHELL
end
EOF

vagrant up
vagrant ssh
```

### Method 4: Docker with Kernel Downgrade Script

```bash
# Create script to check and install vulnerable kernel
cat > install-vulnerable-kernel.sh << 'EOF'
#!/bin/bash

VULNERABLE_KERNEL="5.15.20-051520-generic"
KERNEL_URL="https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.15.20"

echo "Installing vulnerable kernel $VULNERABLE_KERNEL"

# Download kernel packages
wget $KERNEL_URL/amd64/linux-headers-${VULNERABLE_KERNEL}_*.deb
wget $KERNEL_URL/amd64/linux-image-unsigned-${VULNERABLE_KERNEL}_*.deb
wget $KERNEL_URL/amd64/linux-modules-${VULNERABLE_KERNEL}_*.deb

# Install kernel
sudo dpkg -i *.deb
sudo apt-get install -f

# Update GRUB
sudo update-grub

echo "Vulnerable kernel installed. Reboot to use it."
echo "After reboot, verify with: uname -r"
EOF

chmod +x install-vulnerable-kernel.sh
```

## üß™ **Testing the Vulnerability**

### Step 1: Verify Vulnerable Kernel
```bash
uname -r  # Should show 5.8.x to 5.15.24 or 5.16.0-5.16.10

# Check if vulnerable
./test_dirtypipe
```

### Step 2: Create Target Files for Testing
```bash
# Create a read-only file owned by root
sudo echo "Original content" > /tmp/readonly_file.txt
sudo chmod 444 /tmp/readonly_file.txt
sudo chown root:root /tmp/readonly_file.txt

# Create SUID binary target
sudo cp /bin/cat /tmp/suid_target
sudo chmod 4755 /tmp/suid_target
```

### Step 3: Run Exploits

#### Test 1: Basic File Overwrite
```bash
# As regular user, try to overwrite read-only file
./test_dirtypipe
```

#### Test 2: SUID Binary Hijacking
```bash
# Use exploit to create root shell
./exploit /tmp/suid_target
```

#### Test 3: Persistence Test
```bash
# Test overwriting system files (BE CAREFUL!)
./exploit_fixed /etc/passwd  # DANGEROUS - backup first!
```

## üìä **Expected Results**

### In Vulnerable Kernel:
- ‚úÖ **File overwrite succeeds** despite read-only permissions
- ‚úÖ **SUID hijacking works** - get root shell
- ‚úÖ **System file modification** succeeds
- ‚úÖ **Container image modification** persists

### In Patched Kernel:
- ‚ùå File overwrite fails
- ‚ùå SUID hijacking fails  
- ‚ùå System files remain protected
- ‚ùå Exploit returns error

## üîß **Troubleshooting**

### If Exploit Fails on "Vulnerable" System:
1. **Check actual kernel version**: `uname -r`
2. **Verify kernel compile date**: `uname -v`
3. **Check if backported patches**: Some distros backport security fixes
4. **Test with different files**: Try different target files
5. **Check AppArmor/SELinux**: May interfere with exploit

### Common Issues:
```bash
# Issue: splice() returns -1
# Solution: Check file permissions and pipe setup

# Issue: "Operation not permitted"
# Solution: Verify running as non-root user initially

# Issue: No output changes
# Solution: Check if file is actually in page cache
```

## üéØ **Best Testing Environments**

### Highest Success Rate:
1. **Ubuntu 21.04 VM** (kernel 5.11.x) - 95% success
2. **Manually compiled 5.15.20** - 90% success  
3. **Ubuntu 20.04.3** (kernel 5.11.x) - 85% success

### Moderate Success:
1. **Vagrant boxes** with older kernels - 70% success
2. **Cloud instances** (check kernel first) - 60% success

## ‚ö†Ô∏è **Safety Warnings**

- **NEVER test on production systems**
- **Always backup important files before testing**
- **Test in isolated VMs only**
- **Use snapshots for easy rollback**
- **Monitor system integrity during tests**

## üîó **Resources**

- [Original Disclosure](https://dirtypipe.cm4all.com/)
- [Kernel.org Security](https://www.kernel.org/category/security.html)
- [Ubuntu Kernel Packages](https://kernel.ubuntu.com/~kernel-ppa/mainline/)
- [CVE-2022-0847 Details](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0847) 