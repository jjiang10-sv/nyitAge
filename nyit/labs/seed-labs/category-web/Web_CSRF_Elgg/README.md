# CSRF Lab


## Issues with the newer Firefox versions (9/9/2023)

We found out that newer version of Firefox (e.g., 117.0) 
have different behaviors than the older versions (e.g., 104.0).
In the newer version, the CSRF attack on the GET request (add friend)
using the image tag does not seem to work. We did some investigation,
trying to figure out the reason. We document our investigation
results here (the investigation is still incomplete). We also
added a special note in the lab description, warning the users
about the difference. 

It seems that newer versions of Firefox block the cross-site cookies for 
the GET requests generated from the image tag. When we send out a GET request 
using the image tag, we saw that Elgg's session cookie is not attached.
Because of this, Elgg will set a new session cookie in the response, 
but this cookie is not the same as the 
one in the current session, i.e., it does not represent
the active session (it is mainly for the login page). 
If we send out another GET request 
using the image tag, this time, the cookie will be attached.
It seems that Firefox feels it is safe to attach this new cookie. 
However, since this session cookie does not represent the current
active session, the attack will still fail. 

For the cross-site GET requests generated from other means, such as from
the clicking or from the form submission, Firefox will not block
the cookies. The Elgg's active session cookie will be attached.
After making such a request, if we go back to use the image tag
to generate a GET request, we found that this time the Elgg's 
active session cookie is attached, and the add-friend attack
can succeed. 

What we still don't understand is what led to the cookie change
for the GET request generated by the image tag. We stopped our 
investigation here. Maybe in the future, we can make further 
progress on this issue. 


## Porting to Ubuntu 20.04

This lab works on both Ubuntu 16.04 and 20.04 VM.
We didn't change any existing attack tasks when porting this 
lab to Ubuntu 20.04 VM. 

For the countermeasure, we revised the secret token 
section, because the Elgg program has changed. We added 
a new task on samesite cookies. 


## For Container Setup

We have moved the Elgg setup to containers, and our Ubuntu 20.04 VM
will no longer host the Elgg website. Since we only need
a browser on the VM, this lab can be done using
generic machines, no longer depending on our VM.


